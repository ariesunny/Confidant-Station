#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <errno.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/stat.h>
#include "crc32.h"

unsigned short crc16_ccitt_table[256] =
{
	0x0000, 0x7f33, 0xfe66, 0x8155, 0x2111, 0x5e22, 0xdf77, 0xa044,
	0x4222, 0x3d11, 0xbc44, 0xc377, 0x6333, 0x1c00, 0x9d55, 0xe266,
	0x8444, 0xfb77, 0x7a22, 0x0511, 0xa555, 0xda66, 0x5b33, 0x2400,
	0xc666, 0xb955, 0x3800, 0x4733, 0xe777, 0x9844, 0x1911, 0x6622,
	0xd555, 0xaa66, 0x2b33, 0x5400, 0xf444, 0x8b77, 0x0a22, 0x7511,
	0x9777, 0xe844, 0x6911, 0x1622, 0xb666, 0xc955, 0x4800, 0x3733,
	0x5111, 0x2e22, 0xaf77, 0xd044, 0x7000, 0x0f33, 0x8e66, 0xf155,
	0x1333, 0x6c00, 0xed55, 0x9266, 0x3222, 0x4d11, 0xcc44, 0xb377,
	0x7777, 0x0844, 0x8911, 0xf622, 0x5666, 0x2955, 0xa800, 0xd733,
	0x3555, 0x4a66, 0xcb33, 0xb400, 0x1444, 0x6b77, 0xea22, 0x9511,
	0xf333, 0x8c00, 0x0d55, 0x7266, 0xd222, 0xad11, 0x2c44, 0x5377,
	0xb111, 0xce22, 0x4f77, 0x3044, 0x9000, 0xef33, 0x6e66, 0x1155,
	0xa222, 0xdd11, 0x5c44, 0x2377, 0x8333, 0xfc00, 0x7d55, 0x0266,
	0xe000, 0x9f33, 0x1e66, 0x6155, 0xc111, 0xbe22, 0x3f77, 0x4044,
	0x2666, 0x5955, 0xd800, 0xa733, 0x0777, 0x7844, 0xf911, 0x8622,
	0x6444, 0x1b77, 0x9a22, 0xe511, 0x4555, 0x3a66, 0xbb33, 0xc400,
	0xeeee, 0x91dd, 0x1088, 0x6fbb, 0xcfff, 0xb0cc, 0x3199, 0x4eaa,
	0xaccc, 0xd3ff, 0x52aa, 0x2d99, 0x8ddd, 0xf2ee, 0x73bb, 0x0c88,
	0x6aaa, 0x1599, 0x94cc, 0xebff, 0x4bbb, 0x3488, 0xb5dd, 0xcaee,
	0x2888, 0x57bb, 0xd6ee, 0xa9dd, 0x0999, 0x76aa, 0xf7ff, 0x88cc,
	0x3bbb, 0x4488, 0xc5dd, 0xbaee, 0x1aaa, 0x6599, 0xe4cc, 0x9bff,
	0x7999, 0x06aa, 0x87ff, 0xf8cc, 0x5888, 0x27bb, 0xa6ee, 0xd9dd,
	0xbfff, 0xc0cc, 0x4199, 0x3eaa, 0x9eee, 0xe1dd, 0x6088, 0x1fbb,
	0xfddd, 0x82ee, 0x03bb, 0x7c88, 0xdccc, 0xa3ff, 0x22aa, 0x5d99,
	0x9999, 0xe6aa, 0x67ff, 0x18cc, 0xb888, 0xc7bb, 0x46ee, 0x39dd,
	0xdbbb, 0xa488, 0x25dd, 0x5aee, 0xfaaa, 0x8599, 0x04cc, 0x7bff,
	0x1ddd, 0x62ee, 0xe3bb, 0x9c88, 0x3ccc, 0x43ff, 0xc2aa, 0xbd99,
	0x5fff, 0x20cc, 0xa199, 0xdeaa, 0x7eee, 0x01dd, 0x8088, 0xffbb,
	0x4ccc, 0x33ff, 0xb2aa, 0xcd99, 0x6ddd, 0x12ee, 0x93bb, 0xec88,
	0x0eee, 0x71dd, 0xf088, 0x8fbb, 0x2fff, 0x50cc, 0xd199, 0xaeaa,
	0xc888, 0xb7bb, 0x36ee, 0x49dd, 0xe999, 0x96aa, 0x17ff, 0x68cc,
	0x8aaa, 0xf599, 0x74cc, 0x0bff, 0xabbb, 0xd488, 0x55dd, 0x2aee
};

unsigned int crc_table[256] = {0};

void init_crc_table(void)
{
	unsigned int c;
	unsigned int i, j;
	
	for (i = 0; i < 256; i++) 
	{
		c = (unsigned int)i;
		for (j = 0; j < 8; j++) 
		{
			if (c & 1)
				c = 0xedb88320L ^ (c >> 1);
			else
				c = c >> 1;
		}
		crc_table[i] = c;
	}
}

/*计算buffer的crc校验码*/
unsigned int crc32(unsigned int crc,unsigned char *buffer, unsigned int size)
{
	unsigned int i;
	//char buf[2048] = {0};
	
	for (i = 0; i < size; i++) 
	{
		crc = crc_table[(crc ^ buffer[i]) & 0xff] ^ (crc >> 8);
	}
	
	return crc;
}

unsigned short crc16(unsigned char *message, unsigned int len)
{
	unsigned short crc_reg = 0;
	unsigned char tempdata = 0 ;

	while (len--) {
		tempdata = *message++;
		crc_reg = (crc_reg >> 8) ^ crc16_ccitt_table[(crc_reg ^ tempdata) & 0xff];
	}
	
	return crc_reg;
}

//在线校验计算网站
//http://www.ip33.com/crc.html

//crc 16 cmodem算法
#define PLOY 0X1021
unsigned short gen_crc16(const unsigned char *data, unsigned short size)
{
    unsigned short crc = 0;
    unsigned char i;
    for (; size > 0; size--) {
        crc = crc ^ (*data++ <<8);
        for (i = 0; i < 8; i++) {
            if (crc & 0X8000) {
                crc = (crc << 1) ^ PLOY;
            }else {
                crc <<= 1;
            }
        }
        crc &= 0XFFFF;
    }
    return crc;
}
const unsigned char chCRCHTalbe[] = // CRC 高位字节值表
{
    0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41,
    0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40,
    0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41,
    0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41,
    0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41,
    0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40,
    0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40,
    0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40,
    0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41,
    0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40,
    0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41,
    0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41,
    0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41,
    0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41,
    0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41,
    0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41,
    0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41,
    0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40,
    0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41,
    0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41,
    0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41,
    0x00, 0xC1, 0x81, 0x40
};


const unsigned char chCRCLTalbe[] = // CRC 低位字节值表
{
    0x00, 0xC0, 0xC1, 0x01, 0xC3, 0x03, 0x02, 0xC2, 0xC6, 0x06, 0x07, 0xC7,
    0x05, 0xC5, 0xC4, 0x04, 0xCC, 0x0C, 0x0D, 0xCD, 0x0F, 0xCF, 0xCE, 0x0E,
    0x0A, 0xCA, 0xCB, 0x0B, 0xC9, 0x09, 0x08, 0xC8, 0xD8, 0x18, 0x19, 0xD9,
    0x1B, 0xDB, 0xDA, 0x1A, 0x1E, 0xDE, 0xDF, 0x1F, 0xDD, 0x1D, 0x1C, 0xDC,
    0x14, 0xD4, 0xD5, 0x15, 0xD7, 0x17, 0x16, 0xD6, 0xD2, 0x12, 0x13, 0xD3,
    0x11, 0xD1, 0xD0, 0x10, 0xF0, 0x30, 0x31, 0xF1, 0x33, 0xF3, 0xF2, 0x32,
    0x36, 0xF6, 0xF7, 0x37, 0xF5, 0x35, 0x34, 0xF4, 0x3C, 0xFC, 0xFD, 0x3D,
    0xFF, 0x3F, 0x3E, 0xFE, 0xFA, 0x3A, 0x3B, 0xFB, 0x39, 0xF9, 0xF8, 0x38,
    0x28, 0xE8, 0xE9, 0x29, 0xEB, 0x2B, 0x2A, 0xEA, 0xEE, 0x2E, 0x2F, 0xEF,
    0x2D, 0xED, 0xEC, 0x2C, 0xE4, 0x24, 0x25, 0xE5, 0x27, 0xE7, 0xE6, 0x26,
    0x22, 0xE2, 0xE3, 0x23, 0xE1, 0x21, 0x20, 0xE0, 0xA0, 0x60, 0x61, 0xA1,
    0x63, 0xA3, 0xA2, 0x62, 0x66, 0xA6, 0xA7, 0x67, 0xA5, 0x65, 0x64, 0xA4,
    0x6C, 0xAC, 0xAD, 0x6D, 0xAF, 0x6F, 0x6E, 0xAE, 0xAA, 0x6A, 0x6B, 0xAB,
    0x69, 0xA9, 0xA8, 0x68, 0x78, 0xB8, 0xB9, 0x79, 0xBB, 0x7B, 0x7A, 0xBA,
    0xBE, 0x7E, 0x7F, 0xBF, 0x7D, 0xBD, 0xBC, 0x7C, 0xB4, 0x74, 0x75, 0xB5,
    0x77, 0xB7, 0xB6, 0x76, 0x72, 0xB2, 0xB3, 0x73, 0xB1, 0x71, 0x70, 0xB0,
    0x50, 0x90, 0x91, 0x51, 0x93, 0x53, 0x52, 0x92, 0x96, 0x56, 0x57, 0x97,
    0x55, 0x95, 0x94, 0x54, 0x9C, 0x5C, 0x5D, 0x9D, 0x5F, 0x9F, 0x9E, 0x5E,
    0x5A, 0x9A, 0x9B, 0x5B, 0x99, 0x59, 0x58, 0x98, 0x88, 0x48, 0x49, 0x89,
    0x4B, 0x8B, 0x8A, 0x4A, 0x4E, 0x8E, 0x8F, 0x4F, 0x8D, 0x4D, 0x4C, 0x8C,
    0x44, 0x84, 0x85, 0x45, 0x87, 0x47, 0x46, 0x86, 0x82, 0x42, 0x43, 0x83,
    0x41, 0x81, 0x80, 0x40
};
/****************************************************************************
** 函数名称：CalculateCRC16
** 函数功能：数据采集器modbus规约CRC16 校验
** 入口参数：pchMsg : 除去起始符的十六进制数组;
**           wDataLen: pchMsg的长度
** 出口参数：返回16位CRC
****************************************************************************/
unsigned short CalculateCRC16(unsigned char* pchMsg, unsigned short wDataLen)
{
    unsigned char chCRCHi = 0xFF; // 高CRC字节初始化
    unsigned char chCRCLo = 0xFF; // 低CRC字节初始化
    unsigned short wIndex; // CRC循环中的索引

    while (wDataLen--)
    {
        // 计算CRC
        wIndex = chCRCLo ^ *pchMsg++ ;
        chCRCLo = chCRCHi ^ chCRCHTalbe[wIndex];
        chCRCHi = chCRCLTalbe[wIndex] ;
    }

    return ((chCRCHi << 8) | chCRCLo) ;
}
